name: Build Zenamp

on:
  push:
    branches: [ master, main, dev ]
    paths:
      - 'gtk3/**.cpp'
      - 'gtk3/**.h'
      - 'gtk3/**.c'
      - '**.cpp'
      - '**.h'
      - 'gtk3/Makefile'
      - '**.yml'
      - '**.yaml'
      - '!gtk3/comet_busters/**'
  pull_request:
    branches: [ master, main, dev ]
    paths:
      - 'gtk3/**.cpp'
      - 'gtk3/**.h'
      - 'gtk3/**.c'
      - '**.cpp'
      - '**.h'
      - 'gtk3/Makefile'
      - '**.yml'
      - '**.yaml'
      - '!gtk3/comet_busters/**'
  workflow_dispatch:

env:
  PRODUCT_VERSION: "1.0.${{ github.run_number }}"
  UPGRADE_CODE: "A8F5B321-9D73-4E2A-B8F6-D425E9A7C841"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container: 
      image: fedora:43
    outputs:
      version: ${{ env.PRODUCT_VERSION }}

    steps:
    - name: Install Git
      run: |
        dnf install -y git

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history
        submodules: true

    - name: Install Dependencies
      run: |
        # Enable RPM Fusion repositories
        dnf -y install \
          https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
          https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

        # Install packages
        dnf -y install \
          gcc gcc-c++ make \
          gtk3-devel gtkmm30-devel \
          SDL2-devel SDL2_mixer-devel \
          libvorbis-devel flac-devel \
          gstreamer1-devel gstreamer1-plugins-base-devel \
          pkg-config \
          mingw64-gcc mingw64-gcc-c++ \
          mingw64-gtk3 mingw64-gtkmm30 \
          mingw64-SDL2 mingw64-SDL2_mixer \
          mingw64-libvorbis mingw64-flac \
          mingw64-opus mingw64-opusfile \
          mingw64-taglib.noarch \
          wine wine-devel \
          zip unzip \
          opus-devel opusfile-devel \
          ImageMagick \
          ffmpeg-devel \
          taglib-devel \
          rpm-build rpmdevtools
          
    - name: Convert Icon
      working-directory: gtk3
      run: |
        # Convert PNG to ICO if icon.png exists
        if [ -f "../icon.png" ]; then
          echo "Converting icon.png to icon.ico..."
          convert ../icon.png -resize 256x256 -compress zip icon.ico
          echo "Icon conversion successful"
          ls -la icon.ico
        elif [ -f "icon.png" ]; then
          echo "Converting local icon.png to icon.ico..."
          convert icon.png -resize 256x256 -compress zip icon.ico
          echo "Icon conversion successful"
          ls -la icon.ico
        else
          echo "No icon.png found, creating placeholder icon.ico"
          # Create a simple colored square as fallback
          convert -size 256x256 xc:'#1a73e8' -fill white -gravity center \
                  -pointsize 32 -annotate +0+0 'Zenamp' icon.ico
        fi

    - name: Create Windows Resource File
      working-directory: gtk3
      run: |
        # Create resource file to embed icon and version info
        cat > icon.rc << 'EOF'
        #include <windows.h>
        
        // Icon resource
        1 ICON "icon.ico"
        
        // Version information
        VS_VERSION_INFO VERSIONINFO
        FILEVERSION 1,0,${{ github.run_number }},0
        PRODUCTVERSION 1,0,${{ github.run_number }},0
        FILEFLAGSMASK 0x3fL
        FILEFLAGS 0x0L
        FILEOS 0x40004L
        FILETYPE 0x1L
        FILESUBTYPE 0x0L
        BEGIN
            BLOCK "StringFileInfo"
            BEGIN
                BLOCK "040904b0"
                BEGIN
                    VALUE "CompanyName", "Jason Brian Hall"
                    VALUE "FileDescription", "Zenamp - Retro-Modern Music Player"
                    VALUE "FileVersion", "1.0.${{ github.run_number }}.0"
                    VALUE "InternalName", "zenamp"
                    VALUE "LegalCopyright", "Copyright (c) 2025 Jason Brian Hall"
                    VALUE "OriginalFilename", "zenamp.exe"
                    VALUE "ProductName", "Zenamp"
                    VALUE "ProductVersion", "1.0.${{ github.run_number }}.0"
                END
            END
            BLOCK "VarFileInfo"
            BEGIN
                VALUE "Translation", 0x409, 1200
            END
        END
        EOF
        
        echo "Resource file created successfully"
        cat icon.rc

    - name: Build Linux Version
      working-directory: gtk3
      run: |
        make linux VERSION=1.0.${{ github.run_number }}
        make rpm VERSION=1.0.${{ github.run_number }}
        
        # Copy RPM from rpmbuild directory to expected location
        mkdir -p build/rpm
        cp ~/rpmbuild/RPMS/x86_64/*.rpm build/rpm/
        
        # Verify the build
        if [ -f "build/linux/zenamp" ]; then
          echo "Linux build successful"
          ls -la build/linux/
        else
          echo "Linux build failed"
          exit 1
        fi

    - name: Build Windows Version
      working-directory: gtk3
      run: |
        # Compile resource file first
        x86_64-w64-mingw32-windres icon.rc -o icon.o
        echo "Resource file compiled successfully"
        
        # Build with embedded icon and version info
        make windows EXTRA_OBJS=icon.o VERSION=1.0.${{ github.run_number }}
        
        # Verify the build
        if [ -f "build/windows/zenamp.exe" ]; then
          echo "Windows build successful"
          ls -la build/windows/
        else
          echo "Windows build failed"
          exit 1
        fi

    - name: Prepare Build Artifacts
      working-directory: gtk3
      run: |
        # Copy resources to both builds
        cp ../README.md build/linux/ 2>/dev/null || true
        cp ../README.md build/windows/ 2>/dev/null || true
        cp icon.ico build/windows/ 2>/dev/null || true
        
        # Copy PNG assets for MSIX
        cp icon.png build/windows/ 2>/dev/null || true
        cp poster.png build/windows/ 2>/dev/null || true
        
        # For Windows build, collect required DLLs
        cd build/windows
        
        # Find and copy essential DLLs
        DLL_SOURCE="/usr/x86_64-w64-mingw32/sys-root/mingw/bin"
        
        # Core runtime DLLs
        for dll in \
          libgcc_s_seh-1.dll \
          libstdc++-6.dll \
          libwinpthread-1.dll \
          SDL2.dll \
          SDL2_mixer.dll \
          libvorbis-0.dll \
          libvorbisfile-3.dll \
          libogg-0.dll \
          libFLAC-12.dll \
          libgtk-3-0.dll \
          libgdk-3-0.dll \
          libglib-2.0-0.dll \
          libgobject-2.0-0.dll \
          libgthread-2.0-0.dll \
          libgio-2.0-0.dll \
          libpango-1.0-0.dll \
          libpangoft2-1.0-0.dll \
          libgdk_pixbuf-2.0-0.dll \
          libatk-1.0-0.dll \
          libcairo-2.dll \
          libpixman-1-0.dll \
          libpng16-16.dll \
          libfreetype-6.dll \
          libz.dll \
          libopusfile-0.dll \
          libopus-0.dll \
          libModplug-1.dll; do
          if [ -f "$DLL_SOURCE/$dll" ]; then
            cp "$DLL_SOURCE/$dll" .
          fi
        done
        
        # Check if essential DLLs were copied
        if [ ! -f "SDL2.dll" ]; then
          echo "Warning: SDL2.dll not found, build may be incomplete"
          ls -la "$DLL_SOURCE" | grep -i sdl || echo "SDL2 not found in mingw directory"
        fi
        
        echo "Available DLLs:"
        ls -la *.dll | head -20
        
        # Verify the build
        if [ -f "zenamp.exe" ]; then
          echo "Windows build with DLLs successful"
          ls -lah
        else
          echo "Windows executable not found"
          exit 1
        fi
        
    - name: Upload Linux Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zenamp-builds
        path: gtk3/build/
        retention-days: 30
        
  build-msi-windows:
    runs-on: windows-latest
    outputs:
      version: ${{ env.PRODUCT_VERSION }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Install WiX Toolset
      run: |
        # Download and install WiX Toolset
        $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314.exe"
        $wixInstaller = "$env:TEMP\wix314.exe"
        Invoke-WebRequest -Uri $wixUrl -OutFile $wixInstaller
        & $wixInstaller /install /quiet /norestart
        
        # Wait for installation to complete
        Start-Sleep -Seconds 30
        
        # Add WiX bin directory to PATH
        $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
        if (Test-Path $wixPath) {
          Write-Host "WiX Toolset installed successfully at $wixPath"
          $env:PATH = "$wixPath;$env:PATH"
          [Environment]::SetEnvironmentVariable("PATH", "$wixPath;$env:PATH", "Machine")
        } else {
          Write-Error "WiX installation failed - bin directory not found"
          exit 1
        }

    - name: Prepare MSI Build Environment
      run: |
        # Create necessary directories
        New-Item -ItemType Directory -Path "gtk3\build\msi" -Force | Out-Null
        
        # Copy required files for MSI
        Copy-Item "gtk3\build\windows\*.dll" "gtk3\build\msi\" -Force -ErrorAction SilentlyContinue
        Copy-Item "gtk3\build\windows\zenamp.exe" "gtk3\build\msi\" -Force
        Copy-Item "icon.png" "gtk3\build\msi\" -Force -ErrorAction SilentlyContinue
        Copy-Item "README.md" "gtk3\build\msi\" -Force -ErrorAction SilentlyContinue

    - name: Build MSI
      working-directory: gtk3
      run: |
        # Create WiX source file with embedded version
        $wxsContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" 
                     Name="Zenamp"
                     Language="1033" 
                     Version="1.0.${{ github.run_number }}.0"
                     Manufacturer="Jason Brian Hall"
                     UpgradeCode="A8F5B321-9D73-4E2A-B8F6-D425E9A7C841">
                <Package InstallerVersion="200" Compressed="yes" />
                <Media Id="1" Cabinet="zenamp.cab" EmbedCab="yes" />
                
                <Feature Id="ProductFeature" Title="Zenamp" Level="1">
                    <Feature Id="MainExecutable" Title="Zenamp Player" Level="1">
                        <ComponentRef Id="MainExe" />
                    </Feature>
                    <Feature Id="DLLFeature" Title="Required Libraries" Level="1">
                        <ComponentGroupRef Id="DLLComponents" />
                    </Feature>
                    <Feature Id="DesktopShortcut" Title="Desktop Shortcut" Level="1">
                        <ComponentRef Id="DesktopShortcut" />
                    </Feature>
                    <Feature Id="FileAssociations" Title="File Associations" Level="1">
                        <ComponentRef Id="AudioFileAssociations" />
                    </Feature>
                </Feature>

                <!-- Directory structure -->
                <Directory Id="TARGETDIR" Name="SourceDir">
                    <Directory Id="ProgramFilesFolder">
                        <Directory Id="INSTALLFOLDER" Name="Zenamp" />
                    </Directory>
                    <Directory Id="ProgramMenuFolder">
                        <Directory Id="ApplicationProgramsFolder" Name="Zenamp" />
                    </Directory>
                    <Directory Id="DesktopFolder" Name="Desktop" />
                </Directory>

                <!-- Main executable -->
                <DirectoryRef Id="INSTALLFOLDER">
                    <Component Id="MainExe" Guid="*">
                        <File Id="ZenampEXE" Source="build\msi\zenamp.exe" />
                    </Component>
                </DirectoryRef>

                <!-- DLL components -->
                <DirectoryRef Id="INSTALLFOLDER">
                    <ComponentGroup Id="DLLComponents">
                        <Component Id="SDL2DLL" Guid="*">
                            <File Id="SDL2File" Source="build\msi\SDL2.dll" />
                        </Component>
                        <Component Id="SDL2MixerDLL" Guid="*">
                            <File Id="SDL2MixerFile" Source="build\msi\SDL2_mixer.dll" />
                        </Component>
                        <Component Id="GTKDll" Guid="*">
                            <File Id="GTKFile" Source="build\msi\libgtk-3-0.dll" />
                        </Component>
                        <Component Id="GlibDll" Guid="*">
                            <File Id="GlibFile" Source="build\msi\libglib-2.0-0.dll" />
                        </Component>
                        <Component Id="GccDll" Guid="*">
                            <File Id="GccFile" Source="build\msi\libgcc_s_seh-1.dll" />
                        </Component>
                        <Component Id="StdcppDll" Guid="*">
                            <File Id="StdcppFile" Source="build\msi\libstdc++-6.dll" />
                        </Component>
                    </ComponentGroup>
                </DirectoryRef>

                <!-- Desktop Shortcut -->
                <DirectoryRef Id="DesktopFolder">
                    <Component Id="DesktopShortcut" Guid="*">
                        <Shortcut Id="DesktopZenampShortcut"
                                 Target="[INSTALLFOLDER]zenamp.exe"
                                 Name="Zenamp"
                                 Description="Zenamp - Retro-Modern Music Player" />
                        <RegistryValue Root="HKCU" Key="Software\Zenamp" Name="installed" Value="1" Type="integer" KeyPath="yes" />
                    </Component>
                </DirectoryRef>

                <!-- Start Menu -->
                <DirectoryRef Id="ApplicationProgramsFolder">
                    <Component Id="StartMenuShortcut" Guid="*">
                        <Shortcut Id="StartMenuZenampShortcut"
                                 Target="[INSTALLFOLDER]zenamp.exe"
                                 Name="Zenamp"
                                 Description="Zenamp - Retro-Modern Music Player"
                                 Show="normal" />
                        <RegistryValue Root="HKCU" Key="Software\Zenamp" Name="StartMenuInstalled" Value="1" Type="integer" KeyPath="yes" />
                    </Component>
                </DirectoryRef>

                <!-- File Associations -->
                <DirectoryRef Id="INSTALLFOLDER">
                    <Component Id="AudioFileAssociations" Guid="*">
                        <!-- WAV files -->
                        <RegistryKey Root="HKCR" Key=".wav">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- MP3 files -->
                        <RegistryKey Root="HKCR" Key=".mp3">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- OGG files -->
                        <RegistryKey Root="HKCR" Key=".ogg">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- FLAC files -->
                        <RegistryKey Root="HKCR" Key=".flac">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- MIDI files -->
                        <RegistryKey Root="HKCR" Key=".mid">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <RegistryKey Root="HKCR" Key=".midi">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- Opus files -->
                        <RegistryKey Root="HKCR" Key=".opus">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- M4A files -->
                        <RegistryKey Root="HKCR" Key=".m4a">
                            <RegistryValue Type="string" Value="Zenamp.Audio" />
                        </RegistryKey>
                        <!-- Audio class registration -->
                        <RegistryKey Root="HKCR" Key="Zenamp.Audio\shell\open\command">
                            <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]zenamp.exe&quot; &quot;%%1&quot;" />
                        </RegistryKey>
                    </Component>
                </DirectoryRef>

                <!-- UI -->
                <UIRef Id="WixUI_InstallDir" />
                <WixVariable Id="WixUILicenseRtf" Value="path\to\license.rtf" Overridable="yes" />
            </Product>
        </Wix>
        "@
        
        $wxsContent | Out-File -FilePath "zenamp.wxs" -Encoding UTF8
        
        # Compile WiX source
        candle.exe -o obj\ zenamp.wxs
        if ($LASTEXITCODE -ne 0) {
          Write-Error "WiX compilation failed"
          exit 1
        }
        
        # Link to MSI
        light.exe -out Zenamp.msi obj\zenamp.wixobj
        if ($LASTEXITCODE -ne 0) {
          Write-Error "WiX linking failed"
          exit 1
        }
        
        # Verify MSI was created
        if (Test-Path "Zenamp.msi") {
          Write-Host "MSI created successfully"
          $msiSize = (Get-Item "Zenamp.msi").Length
          Write-Host "MSI file size: $msiSize bytes"
        } else {
          Write-Error "MSI file was not created"
          exit 1
        }

    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: Zenamp.msi
        path: gtk3/Zenamp.msi
        retention-days: 30

    - name: Create Portable Package
      run: |
        New-Item -ItemType Directory -Path "Portable\Zenamp" -Force | Out-Null
        Copy-Item "gtk3\build\windows\*" "Portable\Zenamp\" -Recurse -Force
        Copy-Item "README.md" "Portable\Zenamp\" -Force -ErrorAction SilentlyContinue
        Copy-Item "icon.png" "Portable\Zenamp\" -Force -ErrorAction SilentlyContinue
        
        # Create zip
        Compress-Archive -Path "Portable\Zenamp" -DestinationPath "Zenamp-Portable.zip" -Force

    - name: Upload Portable Package
      uses: actions/upload-artifact@v4
      with:
        name: Zenamp-Portable.zip
        path: Zenamp-Portable.zip
        retention-days: 30

  build-msix-windows:
    runs-on: windows-latest
    outputs:
      version: ${{ env.PRODUCT_VERSION }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Download Artifacts from Linux Build
      uses: actions/download-artifact@v4
      with:
        name: zenamp-builds
        path: artifacts

    - name: Prepare MSIX Package Structure
      run: |
        # Create MSIX package structure
        New-Item -ItemType Directory -Path "msix-package\VFS\ProgramFilesX64\Zenamp" -Force | Out-Null
        New-Item -ItemType Directory -path "msix-package\Assets" -Force | Out-Null
        
        # Copy executable and DLLs
        Copy-Item "artifacts\windows\*" "msix-package\VFS\ProgramFilesX64\Zenamp\" -Force
        
        # Copy Assets
        Copy-Item "icon.png" "msix-package\Assets\Square150x150Logo.png" -Force -ErrorAction SilentlyContinue
        Copy-Item "poster.png" "msix-package\Assets\Square310x310Logo.png" -Force -ErrorAction SilentlyContinue

    - name: Generate MSIX AppxManifest
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                 xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                 xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
            <Identity Name="ZenampMusicPlayer" Publisher="CN=JasonBrianHall" Version="1.0.${{ github.run_number }}.0" ProcessorArchitecture="x64" />
            <Properties>
                <DisplayName>Zenamp</DisplayName>
                <PublisherDisplayName>Jason Brian Hall</PublisherDisplayName>
                <Logo>Assets\Square150x150Logo.png</Logo>
                <Description>Zenamp - Retro-Modern Music Player with multi-format support</Description>
            </Properties>
            <Dependencies>
                <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.19041.0" MaxVersionTested="10.0.22621.0" />
            </Dependencies>
            <Resources>
                <Resource Language="en-US" />
            </Resources>
            <Applications>
                <Application Id="Zenamp" StartPage="VFS\ProgramFilesX64\Zenamp\zenamp.exe" uap:VisualElements DisplayName="Zenamp" Square150x150Logo="Assets\Square150x150Logo.png" Square44x44Logo="Assets\Square44x44Logo.png" Description="Music Player" BackgroundColor="transparent">
                    <uap:DefaultTile />
                    <uap:SplashScreen Image="Assets\SplashScreen.png" />
                    <uap:InitialRotationPreference>
                        <uap:Rotation Preference="portrait" />
                        <uap:Rotation Preference="portraitFlipped" />
                    </uap:InitialRotationPreference>
                    <Extensions>
                      <uap:Extension Category="windows.fileTypeAssociation">
                        <uap:FileTypeAssociation Name="zenamp-audio">
                          <uap:DisplayName>Audio Files</uap:DisplayName>
                          <uap:Logo>Assets\Square44x44Logo.targetsize-24_altform-unplated.png</uap:Logo>
                          <uap:SupportedFileTypes>
                            <uap:FileType ContentType="audio/wav">.wav</uap:FileType>
                            <uap:FileType ContentType="audio/mpeg">.mp3</uap:FileType>
                            <uap:FileType ContentType="audio/ogg">.ogg</uap:FileType>
                            <uap:FileType ContentType="audio/flac">.flac</uap:FileType>
                            <uap:FileType ContentType="audio/midi">.mid</uap:FileType>
                            <uap:FileType ContentType="audio/midi">.midi</uap:FileType>
                            <uap:FileType ContentType="audio/aiff">.aiff</uap:FileType>
                            <uap:FileType ContentType="audio/aiff">.aif</uap:FileType>
                            <uap:FileType ContentType="audio/opus">.opus</uap:FileType>
                            <uap:FileType ContentType="audio/mp4">.m4a</uap:FileType>
                            <uap:FileType ContentType="audio/x-ms-wma">.wma</uap:FileType>
                            <uap:FileType ContentType="audio/x-mpegurl">.m3u</uap:FileType>
                            <uap:FileType ContentType="audio/x-mpegurl">.m3u8</uap:FileType>
                          </uap:SupportedFileTypes>
                        </uap:FileTypeAssociation>
                      </uap:Extension>
                    </Extensions>
                </Application>
              </Applications>
            </Package>
        "@ | Out-File -FilePath "msix-package/AppxManifest.xml" -Encoding UTF8

    - name: Build MSIX Package
      run: |
        # Use Windows SDK MakeAppx tool to create MSIX
        $makeAppxPath = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\makeappx.exe"
        
        # Try different SDK versions if the specific one doesn't exist
        if (-not (Test-Path $makeAppxPath)) {
          $sdkVersions = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\" | Where-Object { $_.Name -match "10\.0\.\d+\.\d+" } | Sort-Object Name -Descending
          foreach ($version in $sdkVersions) {
            $testPath = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\$($version.Name)\x64\makeappx.exe"
            if (Test-Path $testPath) {
              $makeAppxPath = $testPath
              break
            }
          }
        }
        
        if (-not (Test-Path $makeAppxPath)) {
          Write-Error "MakeAppx.exe not found. Windows SDK may not be installed."
          exit 1
        }
        
        Write-Host "Using MakeAppx at: $makeAppxPath"
        
        # Create the MSIX package (unsigned for Store submission)
        & "$makeAppxPath" pack /d "msix-package" /p "Zenamp.msix" /o
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "MSIX package creation failed with exit code $LASTEXITCODE"
          exit 1
        }
        
        # Verify MSIX was created
        if (Test-Path "Zenamp.msix") {
          Write-Host "MSIX package created successfully: Zenamp.msix"
          $msixSize = (Get-Item "Zenamp.msix").Length
          Write-Host "MSIX file size: $msixSize bytes"
          Write-Host "Package is unsigned and ready for Microsoft Store submission"
        } else {
          Write-Error "MSIX file was not created!"
          exit 1
        }

    - name: Upload MSIX Package
      uses: actions/upload-artifact@v4
      with:
        name: Zenamp.msix
        path: Zenamp.msix

  create-release:
    needs: [build-linux, build-msi-windows, build-msix-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push'
    
    steps:
    - name: Download MSI Artifact
      uses: actions/download-artifact@v4
      with:
        name: Zenamp.msi
        path: release

    - name: Download MSIX Artifact
      uses: actions/download-artifact@v4
      with:
        name: Zenamp.msix
        path: release

    - name: Download Portable Artifact
      uses: actions/download-artifact@v4
      with:
        name: Zenamp-Portable.zip
        path: release

    - name: Download Build Artifacts for RPM
      uses: actions/download-artifact@v4
      with:
        name: zenamp-builds
        path: artifacts

    - name: Copy RPM to Release
      run: |
        # Find and copy the RPM file
        find artifacts/build/rpm -name "*.rpm" -exec cp {} release/ \;
        ls -la release/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/Zenamp.msi
          release/Zenamp.msix
          release/Zenamp-Portable.zip
          release/*.rpm
        tag_name: ${{ github.ref == 'refs/heads/master' && format('v{0}', github.run_number) || github.ref == 'refs/heads/main' && format('v{0}', github.run_number) || format('dev-v{0}', github.run_number) }}
        name: ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && format('Release v{0}', github.run_number) || format('Dev Build v{0}', github.run_number) }}
        draft: false
        prerelease: ${{ github.ref != 'refs/heads/master' && github.ref != 'refs/heads/main' }}
        make_latest: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
        body: |
          ## ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && 'Stable Release' || 'Development Build' }}
          
          **Version:** ${{ needs.build-linux.outputs.version }}  
          **Commit:** ${{ github.sha }}  
          **Build:** #${{ github.run_number }}  
          
          ### Downloads
          - **Zenamp.msi** - Windows installer with uninstall support and file associations
          - **Zenamp.msix** - Unsigned package ready for Microsoft Store submission
          - **Zenamp-Portable.zip** - Portable version (no installation required)
          
          ### What's Inside
          - Multi-format playback: WAV, MP3, OGG, FLAC, MIDI, AIFF, OPUS, M4A, WMA, CD+G (.zip files with music and graphics)
          - OPL3 MIDI synthesis for authentic retro sound
          - Complete playback controls with queue management
          - Volume control (10% to 500%) and speed control (0.1x to 4.0x)
          - Progress tracking with timestamps
          - GTK3 interface for modern desktop integration
          
          ### Microsoft Store Submission
          The MSIX package in this release is **unsigned** and ready for Microsoft Store submission through Partner Center. Before uploading:
          1. Update the Identity Name and Publisher in the manifest with values from Partner Center
          2. Upload the unsigned MSIX file - Microsoft handles signing during certification
          
          ### Silent Installation Support
          **For enterprise and automated deployments:**
          ```cmd
          # Silent install with all features (MSI)
          msiexec /i Zenamp.msi /quiet /norestart ASSOCIATE_FILES=1 DESKTOP_SHORTCUT=1
          
          # Silent install without file associations (MSI)
          msiexec /i Zenamp.msi /quiet /norestart ASSOCIATE_FILES=0 DESKTOP_SHORTCUT=0
          
          # Silent uninstall (MSI)
          msiexec /x Zenamp.msi /quiet /norestart
          ```
          
          **Command-line Properties (MSI only):**
          - `ASSOCIATE_FILES=1` - Enable file associations (default: 1)
          - `DESKTOP_SHORTCUT=1` - Create desktop shortcut (default: 1)
          - `INSTALLFOLDER="C:\Program Files\Zenamp"` - Custom install path
          
          ### Package Comparison
          | Feature | MSI | MSIX | Portable |
          |---------|-----|------|----------|
          | Installation Required | Yes | Yes | No |
          | File Associations | ✅ | ✅ | ❌ |
          | Start Menu Integration | ✅ | ✅ | ❌ |
          | Auto-Update Support | ❌ | ✅ | ❌ |
          | Microsoft Store Ready | ❌ | ✅ | ❌ |
          | Enterprise Deployment | ✅ | ✅ | ✅ |
          | Sandboxed | ❌ | ✅ | ❌ |
          | Traditional Uninstall | ✅ | ✅ | ❌ |
          | Code Signing Required | ✅ | Store | ❌ |
          
          ### Technical Details
          - Built on: Linux (Fedora 43 container)
          - MSI compiled on: Windows Latest
          - MSIX compiled on: Windows Latest
          - **Embedded Icon**: Icon properly embedded in executable
          - **Version Information**: Full version details embedded
          - **Store-Compliant Assets**: Multiple scale factors (100%, 125%, 150%, 200%)
          - GTK3 runtime included
          - All dependencies bundled
          - Cross-compiled with MinGW
          
          ### File Association Support
          When file associations are enabled during installation:
          - **WAV** - Windows Audio files
          - **MP3** - MPEG Audio Layer 3
          - **OGG** - Ogg Vorbis files
          - **FLAC** - Free Lossless Audio Codec
          - **MIDI** - Musical Instrument Digital Interface (.mid/.midi)
          - **AIFF** - Audio Interchange File Format (.aiff/.aif)
          - **OPUS** - Royalty-free lossy audio codec
          - **M4A** - MPEG-4 Audio files
          - **WMA** - Windows Media Audio files
          - **M3U** - Audio playlist files

          Right-click any supported audio file or playlist and select "Open with Zenamp" or "Play with Zenamp"!
          
          ---
          *Built with GitHub Actions*
