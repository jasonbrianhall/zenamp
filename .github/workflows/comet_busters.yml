name: Build Comet Busters

on:
  push:
    branches: [ master, main, dev ]
    paths:
      - 'gtk3/comet_busters/**'
      - '.github/workflows/comet_build.yml'
  pull_request:
    branches: [ master, main, dev ]
    paths:
      - 'gtk3/comet_busters/**'
  workflow_dispatch:

env:
  PRODUCT_VERSION: "1.0.${{ github.run_number }}"
  UPGRADE_CODE: "F2C8A7E4-5D92-4B1F-9E6D-C8A2F9E1B3D5"
  APP_NAME: "CometBusters"
  APP_EXE: "cometbuster.exe"

jobs:
  comet-build-linux:
    runs-on: ubuntu-latest
    container: 
      image: fedora:43
    outputs:
      version: ${{ env.PRODUCT_VERSION }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Dependencies
      run: |
        # Enable RPM Fusion repositories
        dnf -y install \
          https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
          https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

        # Install packages
        dnf -y install \
          gcc gcc-c++ make \
          gtk3-devel gtkmm30-devel \
          SDL2-devel SDL2_mixer-devel \
          libvorbis-devel flac-devel \
          pkg-config \
          mingw64-gcc mingw64-gcc-c++ \
          mingw64-gtk3 mingw64-gtkmm30 \
          mingw64-SDL2 mingw64-SDL2_mixer \
          mingw64-libvorbis mingw64-flac \
          mingw64-opus mingw64-opusfile \
          wine wine-devel \
          zip unzip \
          opus-devel opusfile-devel \
          ImageMagick \
          ffmpeg-devel \
          python3 \
          rpm-build rpmdevtools

    - name: Convert Icon
      working-directory: gtk3/comet_busters
      run: |
        # Convert PNG to ICO if icon.png exists in gtk3/comet_busters
        if [ -f "icon.png" ]; then
          echo "Converting icon.png to icon.ico..."
          convert icon.png -resize 256x256 -compress zip icon.ico
          echo "Icon conversion successful"
          ls -la icon.ico
        else
          echo "No icon.png found, creating placeholder icon.ico"
          # Create a colorful CometBusters-themed icon
          convert -size 256x256 xc:'#FF6B35' -fill white -gravity center \
                  -pointsize 32 -annotate +0+0 'Comet' icon.ico
        fi
        echo "Icon ready: icon.ico"
        ls -la icon.ico

    - name: Create Windows Resource File
      working-directory: gtk3/comet_busters
      run: |
        # Create resource file to embed icon and version info
        cat > icon.rc << 'EOF'
        #include <windows.h>
        
        // Icon resource
        1 ICON "icon.ico"
        
        // Version information
        VS_VERSION_INFO VERSIONINFO
        FILEVERSION 1,0,${{ github.run_number }},0
        PRODUCTVERSION 1,0,${{ github.run_number }},0
        FILEFLAGSMASK 0x3fL
        FILEFLAGS 0x0L
        FILEOS 0x40004L
        FILETYPE 0x1L
        FILESUBTYPE 0x0L
        BEGIN
            BLOCK "StringFileInfo"
            BEGIN
                BLOCK "040904b0"
                BEGIN
                    VALUE "CompanyName", "Jason Brian Hall"
                    VALUE "FileDescription", "Comet Busters - Retro Arcade Game"
                    VALUE "FileVersion", "1.0.${{ github.run_number }}.0"
                    VALUE "InternalName", "cometbuster"
                    VALUE "LegalCopyright", "Copyright (c) 2025 Jason Brian Hall"
                    VALUE "OriginalFilename", "cometbuster.exe"
                    VALUE "ProductName", "Comet Busters"
                    VALUE "ProductVersion", "1.0.${{ github.run_number }}.0"
                END
            END
            BLOCK "VarFileInfo"
            BEGIN
                VALUE "Translation", 0x409, 1200
            END
        END
        EOF
        
        echo "Resource file created successfully"
        cat icon.rc

    - name: Build Linux Version
      working-directory: gtk3/comet_busters
      run: |
        make clean-all
        make linux VERSION=1.0.${{ github.run_number }}
        
        # Verify the build
        if [ -f "build/linux/cometbuster" ]; then
          echo "Linux build successful"
          ls -lh build/linux/cometbuster
        else
          echo "Linux build failed"
          exit 1
        fi

    - name: Build Windows Version
      working-directory: gtk3/comet_busters
      run: |
        # Compile resource file first
        x86_64-w64-mingw32-windres icon.rc -o icon.o
        echo "Resource file compiled successfully"
        
        # Build with embedded icon and version info
        make windows EXTRA_OBJS=icon.o VERSION=1.0.${{ github.run_number }}
        
        # Verify the build
        if [ -f "build/windows/cometbuster.exe" ]; then
          echo "Windows build successful"
          ls -lh build/windows/cometbuster.exe
        else
          echo "Windows build failed"
          exit 1
        fi

    - name: Prepare Build Artifacts
      working-directory: gtk3/comet_busters
      run: |
        # Copy resources to both builds
        cp ../../README.md build/linux/ 2>/dev/null || true
        cp ../../README.md build/windows/ 2>/dev/null || true
        cp cometbuster_readme.md build/linux/ 2>/dev/null || true
        cp cometbuster_readme.md build/windows/ 2>/dev/null || true
        
        # Copy game data files
        if [ -f "cometbuster.wad" ]; then
          cp cometbuster.wad build/linux/
          cp cometbuster.wad build/windows/
          echo "Game data file copied"
        fi
        
        # For Windows build, collect required DLLs
        cd build/windows
        
        # Dynamically find and copy ALL DLLs from MinGW
        DLL_SOURCE="/usr/x86_64-w64-mingw32/sys-root/mingw/bin"
        
        echo "Dynamically copying DLLs from: $DLL_SOURCE"
        find "$DLL_SOURCE" -maxdepth 1 -name "*.dll" -type f -exec cp {} . \;
        echo "DLL copy complete"
        
        # Copy GTK runtime directories and schemas
        mkdir -p lib/gdk-pixbuf-2.0
        mkdir -p lib/gtk-3.0
        mkdir -p share/glib-2.0/schemas
        mkdir -p share/icons
        mkdir -p share/themes
        
        # Copy GTK schemas if available
        if [ -d "/usr/x86_64-w64-mingw32/sys-root/mingw/share/glib-2.0/schemas" ]; then
          cp -r /usr/x86_64-w64-mingw32/sys-root/mingw/share/glib-2.0/schemas/* share/glib-2.0/schemas/ 2>/dev/null || true
        fi
        
        # Verify critical DLLs are present
        echo ""
        echo "=== DLL Verification ==="
        for critical in cometbuster.exe SDL2.dll libgtk-3-0.dll SDL2_mixer.dll; do
          if [ -f "$critical" ]; then
            echo "✓ $critical"
          else
            echo "✗ MISSING: $critical"
          fi
        done
        
        echo ""
        echo "=== Windows directory contents ==="
        ls -lh | head -20

    - name: Upload Windows Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cometbuster-windows-build
        path: gtk3/comet_busters/build/windows/

    - name: Upload Linux Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cometbuster-linux-builds
        path: gtk3/comet_busters/build/linux/

  comet-build-msi-windows:
    runs-on: windows-latest
    needs: comet-build-linux
    outputs:
      version: ${{ needs.comet-build-linux.outputs.version }}

    steps:
    - uses: actions/checkout@v4

    - name: Download Windows Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: cometbuster-windows-build
        path: gtk3/comet_busters/build/windows/

    - name: Verify Downloaded Artifacts
      working-directory: gtk3/comet_busters/build/windows
      run: |
        Write-Host "=== Windows Build Directory Contents ==="
        Get-ChildItem -Recurse | ForEach-Object { Write-Host $_.FullName }
        
        Write-Host ""
        Write-Host "=== Checking Critical Files ==="
        $criticalFiles = @("cometbuster.exe", "cometbuster.wad", "SDL2.dll", "libgtk-3-0.dll")
        foreach ($file in $criticalFiles) {
          $exists = Test-Path $file
          Write-Host "$file : $exists"
        }

    - name: Build Windows MSI Installer
      run: |
        cd gtk3\comet_busters
        
        # Create build directory for MSI
        if (-not (Test-Path "build\msi")) {
          New-Item -ItemType Directory -Path "build\msi" -Force | Out-Null
        }
        
        # Copy executable and game data to MSI build directory
        Copy-Item "build\windows\cometbuster.exe" "build\msi\" -Force
        if (Test-Path "build\windows\cometbuster.wad") {
          Copy-Item "build\windows\cometbuster.wad" "build\msi\" -Force
        }
        
        # Copy all DLLs to MSI directory
        $dllFiles = Get-ChildItem "build\windows\*.dll"
        foreach ($dll in $dllFiles) {
          Copy-Item $dll.FullName "build\msi\" -Force
          Write-Host "Copied DLL: $($dll.Name)"
        }
        
        Write-Host ""
        Write-Host "=== MSI Build Directory ==="
        Get-ChildItem "build\msi\" | Format-Table Name, Length
        
        # Create WIX source file for MSI
        $wixSource = @"
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="Comet Busters" Language="1033" Version="1.0.${{ github.run_number }}.0" 
           Manufacturer="Jason Brian Hall" UpgradeCode="F2C8A7E4-5D92-4B1F-9E6D-C8A2F9E1B3D5">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of Comet Busters is already installed." />
    <MediaTemplate EmbedCab="yes" />
    
    <Feature Id="ProductFeature" Title="Comet Busters" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="GameData" />
      <ComponentRef Id="RuntimeDLLs" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="StartMenuShortcut" />
    </Feature>

    <UI Id="WixUI_Minimal" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="Comet Busters" />
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Comet Busters" />
      </Directory>
      <Directory Id="DesktopFolder" />
    </Directory>

    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="*">
        <File Id="CometBusterEXE" Name="cometbuster.exe" Source="build\msi\cometbuster.exe" KeyPath="yes">
          <Shortcut Id="DesktopShortcutExe" Directory="DesktopFolder" Name="Comet Busters" WorkingDirectory="INSTALLFOLDER" Icon="CometIcon.exe" IconIndex="0" Advertise="yes" />
        </File>
      </Component>

      <Component Id="GameData" Guid="*">
        <File Id="CometBusterWAD" Name="cometbuster.wad" Source="build\msi\cometbuster.wad" KeyPath="yes" />
      </Component>

      <Component Id="RuntimeDLLs" Guid="*">
        <File Id="SDL2DLL" Name="SDL2.dll" Source="build\msi\SDL2.dll" />
        <File Id="SDL2MixerDLL" Name="SDL2_mixer.dll" Source="build\msi\SDL2_mixer.dll" />
        <File Id="LibGTK3DLL" Name="libgtk-3-0.dll" Source="build\msi\libgtk-3-0.dll" />
        <File Id="LibGDK3DLL" Name="libgdk-3-0.dll" Source="build\msi\libgdk-3-0.dll" />
        <File Id="LibGLib2DLL" Name="libglib-2.0-0.dll" Source="build\msi\libglib-2.0-0.dll" />
        <File Id="LibGObject2DLL" Name="libgobject-2.0-0.dll" Source="build\msi\libgobject-2.0-0.dll" />
        <File Id="LibGModule2DLL" Name="libgmodule-2.0-0.dll" Source="build\msi\libgmodule-2.0-0.dll" />
        <File Id="LibGIO2DLL" Name="libgio-2.0-0.dll" Source="build\msi\libgio-2.0-0.dll" />
        <File Id="LibGThread2DLL" Name="libgthread-2.0-0.dll" Source="build\msi\libgthread-2.0-0.dll" />
        <File Id="LibPango1DLL" Name="libpango-1.0-0.dll" Source="build\msi\libpango-1.0-0.dll" />
        <File Id="LibPangoCairo1DLL" Name="libpangocairo-1.0-0.dll" Source="build\msi\libpangocairo-1.0-0.dll" />
        <File Id="LibVorbis0DLL" Name="libvorbis-0.dll" Source="build\msi\libvorbis-0.dll" />
        <File Id="LibVorbisFile3DLL" Name="libvorbisfile-3.dll" Source="build\msi\libvorbisfile-3.dll" />
        <File Id="LibOgg0DLL" Name="libogg-0.dll" Source="build\msi\libogg-0.dll" />
        <File Id="LibFLAC12DLL" Name="libFLAC-12.dll" Source="build\msi\libFLAC-12.dll" />
        <File Id="LibCairo2DLL" Name="libcairo-2.dll" Source="build\msi\libcairo-2.dll" />
        <File Id="LibFreetype6DLL" Name="libfreetype-6.dll" Source="build\msi\libfreetype-6.dll" />
        <File Id="LibHarfbuzz0DLL" Name="libharfbuzz-0.dll" Source="build\msi\libharfbuzz-0.dll" />
        <File Id="LibIntl8DLL" Name="libintl-8.dll" Source="build\msi\libintl-8.dll" />
        <File Id="LibStdCxx6DLL" Name="libstdc++-6.dll" Source="build\msi\libstdc++-6.dll" />
        <File Id="LibGccSeh1DLL" Name="libgcc_s_seh-1.dll" Source="build\msi\libgcc_s_seh-1.dll" />
        <File Id="LibWinPthread1DLL" Name="libwinpthread-1.dll" Source="build\msi\libwinpthread-1.dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="*">
        <Shortcut Id="StartMenuShortcutExe" Name="Comet Busters" Target="[INSTALLFOLDER]cometbuster.exe" WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="ApplicationProgramsFolderComet" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[ProductCode]" Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <RegistryValue Root="HKCU" Key="Software\Comet Busters" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <Icon Id="CometIcon.exe" SourceFile="build\msi\cometbuster.exe" />

    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
  </Product>
</Wix>
"@
        
        $wixSource | Out-File -FilePath "build\msi\CometBusters.wxs" -Encoding UTF8
        
        Write-Host "WIX source file created: build\msi\CometBusters.wxs"
        Write-Host ""
        Write-Host "=== WIX File Content ==="
        Get-Content "build\msi\CometBusters.wxs" | Select-Object -First 30

    - name: Build MSI with WiX
      run: |
        # Check if WiX Toolset is installed
        $wixPath = "${env:ProgramFiles(x86)}\WiX Toolset v3.11\bin"
        
        if (-not (Test-Path $wixPath)) {
          Write-Host "WiX Toolset not found at: $wixPath"
          Write-Host "Installing WiX Toolset..."
          
          # Download and install WiX v3.11
          $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3111rtm/wix311.exe"
          $wixInstaller = "$env:TEMP\wix311.exe"
          
          Invoke-WebRequest -Uri $wixUrl -OutFile $wixInstaller -ErrorAction SilentlyContinue
          
          if (Test-Path $wixInstaller) {
            Write-Host "Running WiX installer..."
            & $wixInstaller /install /quiet /norestart
            Start-Sleep -Seconds 10
          } else {
            Write-Host "Failed to download WiX installer"
            exit 1
          }
        }
        
        $wixBinPath = "${env:ProgramFiles(x86)}\WiX Toolset v3.11\bin"
        
        # Verify WiX installation
        if (-not (Test-Path "$wixBinPath\candle.exe")) {
          Write-Error "WiX Toolset installation failed"
          exit 1
        }
        
        Write-Host "WiX Toolset found at: $wixBinPath"
        
        cd gtk3\comet_busters\build\msi
        
        # Create a minimal License.rtf if it doesn't exist
        if (-not (Test-Path "License.rtf")) {
          $licenseContent = "{\rtf1\ansi\ansicpg1252\cocoartf1652`n{\colortbl;\red255\green255\blue255;}`n{\*\expandedcolortbl;;}`nf0\fnil\fcharset0 Calibri;`n\margl1440\margr1440\margtsxn1440\margbsxn1440`n\trowd\trgaph108\trleft-108\trbrdrt\brdrs\brdrw10 \trbrdrl\brdrs\brdrw10 \trbrdrb\brdrs\brdrw10 \trbrdrr\brdrs\brdrw10 \trbrdrh\brdrs\brdrw10 \trbrdrt\brdrs\brdrw10\n`n\pard\plain\qc\sl480\slmult1 {\*\listtag0}\n`n{\colortbl;\red0\green0\blue0;}\n{\*\expandedcolortbl;;}\n\margl108\margr108\pard\li0\ri0\lin0\rin0\fi0\frin0\sb0\sa0\sl240\slmult1\plain\f0\fs24\b\ltrch\loch\n\loch\ltrch Comet Busters License\par\n`n\pard\plain\ql\sl480\slmult1 {\*\listtag0}\n`n{\colortbl;\red0\green0\blue0;}\n{\*\expandedcolortbl;;}\n\margl108\margr108\pard\li0\ri0\lin0\rin0\fi0\frin0\sb0\sa0\sl240\slmult1\plain\f0\fs20\ltrch\loch\n\loch\ltrch Copyright 2025 Jason Brian Hall\par\n}"
          $licenseContent | Out-File -FilePath "License.rtf" -Encoding ASCII
        }
        
        Write-Host "Building MSI with WiX..."
        
        # Compile WIX to object file
        & "$wixBinPath\candle.exe" -o "CometBusters.wixobj" "CometBusters.wxs"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "WiX candle compilation failed with exit code $LASTEXITCODE"
          exit 1
        }
        
        # Link WIX object file to create MSI
        & "$wixBinPath\light.exe" -o "CometBusters.msi" "CometBusters.wixobj" -ext WixUIExtension -ext WixUtilExtension
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "WiX light linking failed with exit code $LASTEXITCODE"
          exit 1
        }
        
        # Verify MSI was created
        if (Test-Path "CometBusters.msi") {
          Write-Host ""
          Write-Host "✓ MSI package created successfully!"
          $msiSize = (Get-Item "CometBusters.msi").Length
          Write-Host "MSI file size: $([math]::Round($msiSize / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "=== MSI File Info ==="
          Get-Item "CometBusters.msi" | Format-List
        } else {
          Write-Error "MSI file was not created!"
          exit 1
        }

    - name: Create Portable ZIP
      working-directory: gtk3/comet_busters
      run: |
        # Create portable directory
        if (Test-Path "portable") {
          Remove-Item "portable" -Recurse -Force
        }
        New-Item -ItemType Directory -Path "portable" | Out-Null
        
        # Copy executable and dependencies
        Copy-Item "build\msi\*.exe" "portable\"
        Copy-Item "build\msi\*.dll" "portable\"
        Copy-Item "build\msi\*.wad" "portable\" -ErrorAction SilentlyContinue
        
        # Copy readme
        if (Test-Path "cometbuster_readme.md") {
          Copy-Item "cometbuster_readme.md" "portable\README.md"
        }
        
        # Create portable ZIP
        Compress-Archive -Path "portable\*" -DestinationPath "CometBusters-Portable.zip" -Force
        
        Write-Host "✓ Portable ZIP created: CometBusters-Portable.zip"
        $zipSize = (Get-Item "CometBusters-Portable.zip").Length
        Write-Host "ZIP file size: $([math]::Round($zipSize / 1MB, 2)) MB"

    - name: Upload MSI Package
      uses: actions/upload-artifact@v4
      with:
        name: CometBusters.msi
        path: gtk3/comet_busters/build/msi/CometBusters.msi

    - name: Upload Portable ZIP
      uses: actions/upload-artifact@v4
      with:
        name: CometBusters-Portable.zip
        path: gtk3/comet_busters/CometBusters-Portable.zip

  comet-build-msix-windows:
    runs-on: windows-latest
    needs: comet-build-linux

    steps:
    - uses: actions/checkout@v4

    - name: Download Windows Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: cometbuster-windows-build
        path: comet_build_artifacts

    - name: Prepare MSIX Package
      run: |
        # Create MSIX package directory structure
        $msixDir = "gtk3\comet_busters\msix-package"
        
        if (Test-Path $msixDir) {
          Remove-Item $msixDir -Recurse -Force
        }
        New-Item -ItemType Directory -Path "$msixDir" | Out-Null
        
        # Copy files
        Copy-Item "comet_build_artifacts\cometbuster.exe" "$msixDir\" -Force
        Copy-Item "comet_build_artifacts\cometbuster.wad" "$msixDir\" -ErrorAction SilentlyContinue
        Copy-Item "comet_build_artifacts\*.dll" "$msixDir\" -Force
        
        Write-Host "MSIX package directory prepared"
        Get-ChildItem $msixDir | Format-Table Name, Length

    - name: Build MSIX Package
      run: |
        $makeAppxPath = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\makeappx.exe"
        
        # Try different SDK versions if the specific one doesn't exist
        if (-not (Test-Path $makeAppxPath)) {
          $sdkVersions = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "10\.0\.\d+\.\d+" } | Sort-Object Name -Descending
          foreach ($version in $sdkVersions) {
            $testPath = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\$($version.Name)\x64\makeappx.exe"
            if (Test-Path $testPath) {
              $makeAppxPath = $testPath
              break
            }
          }
        }
        
        if (-not (Test-Path $makeAppxPath)) {
          Write-Host "Note: Windows SDK MakeAppx.exe not found - MSIX creation skipped"
          exit 0
        }
        
        Write-Host "Using MakeAppx at: $makeAppxPath"
        
        # Create the MSIX package
        & "$makeAppxPath" pack /d "gtk3\comet_busters\msix-package" /p "CometBusters.msix" /o
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "MSIX package creation skipped (Windows SDK not properly configured)"
          exit 0
        }
        
        # Verify MSIX was created
        if (Test-Path "CometBusters.msix") {
          Write-Host "✓ MSIX package created successfully"
          $msixSize = (Get-Item "CometBusters.msix").Length
          Write-Host "MSIX file size: $([math]::Round($msixSize / 1MB, 2)) MB"
        }

    - name: Upload MSIX Package
      uses: actions/upload-artifact@v4
      with:
        name: CometBusters.msix
        path: CometBusters.msix
      if: hashFiles('CometBusters.msix') != ''

  create-release:
    needs: [comet-build-linux, comet-build-msi-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4

    - name: Download Linux Build
      uses: actions/download-artifact@v4
      with:
        name: cometbuster-linux-builds
        path: release/linux

    - name: Download MSI Package
      uses: actions/download-artifact@v4
      with:
        name: CometBusters.msi
        path: release/windows
      continue-on-error: true

    - name: Download Portable ZIP
      uses: actions/download-artifact@v4
      with:
        name: CometBusters-Portable.zip
        path: release/windows
      continue-on-error: true

    - name: Download MSIX Package
      uses: actions/download-artifact@v4
      with:
        name: CometBusters.msix
        path: release/windows
      continue-on-error: true

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/linux/**/*
          release/windows/**/*
        tag_name: ${{ github.ref == 'refs/heads/master' && format('comet-v{0}', github.run_number) || github.ref == 'refs/heads/main' && format('comet-v{0}', github.run_number) || format('comet-dev-v{0}', github.run_number) }}
        name: ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && format('Comet Busters v{0}', github.run_number) || format('Comet Busters Dev Build v{0}', github.run_number) }}
        draft: false
        prerelease: ${{ github.ref != 'refs/heads/master' && github.ref != 'refs/heads/main' }}
        make_latest: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
        body: |
          ## ${{ (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && 'Stable Release' || 'Development Build' }}
          
          **Version:** 1.0.${{ github.run_number }}  
          **Commit:** ${{ github.sha }}  
          **Build:** #${{ github.run_number }}  
          
          ### Downloads
          
          #### Linux
          - **cometbuster-linux-x64.tar.gz** - Linux x86-64 binary with game data
          
          #### Windows
          - **CometBusters.msi** - Windows installer with file associations and uninstall support
          - **CometBusters-Portable.zip** - Portable version (no installation required)
          - **CometBusters.msix** - Unsigned package ready for Microsoft Store submission (if available)
          
          ### About Comet Busters
          
          Comet Busters is a retro-style arcade game with:
          - Classic asteroid-shooter gameplay
          - Joystick and keyboard support
          - Multiple difficulty waves with boss encounters
          - Sound effects and game music
          - High score tracking
          - Cross-platform availability (Linux & Windows)
          
          ### Game Controls
          
          **Keyboard:**
          - Arrow Keys: Move ship
          - Space: Fire weapon
          - P: Pause game
          - ESC: Exit to menu
          
          **Joystick:**
          - D-Pad/Analog Stick: Move ship
          - Button 1 (A/Cross): Fire
          - Start: Pause
          
          ### Installation
          
          #### Windows - MSI Installer (Recommended)
          1. Download and run CometBusters.msi
          2. Follow the installer prompts
          3. Game will be available in Start Menu and on Desktop
          
          #### Windows - Portable
          1. Extract CometBusters-Portable.zip to any folder
          2. Run cometbuster.exe
          3. No installation required
          
          #### Linux
          1. Extract: tar xzf cometbuster-linux-x64.tar.gz
          2. Run: ./cometbuster
          3. Requires: libgtk-3, libSDL2, libSDL2_mixer
          
          ### System Requirements
          
          **Minimum:**
          - OS: Windows 7+ or Linux
          - CPU: 1 GHz processor
          - RAM: 256 MB
          - Storage: 50 MB
          
          ---
          *Built with GitHub Actions | Cross-compiled with MinGW*
